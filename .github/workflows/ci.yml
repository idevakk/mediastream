name: CI / Release

on:
  push:
    branches: [main]
    tags:     ["v*"]
  pull_request:
    branches: [main]

permissions:
  contents: write   # needed to create GitHub Releases

jobs:
  # ── Lint & Test ──────────────────────────────────────────────────────────
  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.21"
          cache: true

      # Fyne requires system graphics libraries on Linux
      - name: Install Linux deps
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            libgl1-mesa-dev xorg-dev libxkbcommon-dev

      - name: Install FFmpeg (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get install -y ffmpeg

      - name: Install FFmpeg (macOS)
        if: runner.os == 'macOS'
        run: brew install ffmpeg

      - name: Install FFmpeg (Windows)
        if: runner.os == 'Windows'
        run: choco install ffmpeg -y

      - run: go vet ./...
      - run: go test ./... -race

  # ── Cross-platform release binaries ─────────────────────────────────────
  release:
    name: Release
    needs: test
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.21"
          cache: true

      - name: Install Linux build deps
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            libgl1-mesa-dev xorg-dev libxkbcommon-dev \
            gcc-mingw-w64-x86-64   # cross-compiler for Windows

      - name: Build all platforms
        run: make release
        env:
          CGO_ENABLED: "1"
          CC_windows_amd64: x86_64-w64-mingw32-gcc

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          generate_release_notes: true
